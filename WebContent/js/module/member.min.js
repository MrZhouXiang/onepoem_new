/*! site 30-07-2014 */
function memberList(){memberRequest(member.getCache(),member.getRows()),memberSearch(),deleteMember(),loadPage(),menusort()}function menusort(){$("#js_sort_menu").hover(function(){$(this).find(".context-menu").show()},function(){$(this).find(".context-menu").hide()}),$("#js_sort_menu").on("click",".cell a",function(){var a=$(this);a.hasClass("selected")||a.addClass("selected").siblings().removeClass("selected"),memberRequest(member.getCache(),member.getRows())})}function memberSearch(){$(".srh-input").keyup(function(a){var a=a||event,b=a.which||a.keyCode;keyword=$(".srh-input").val();var c=/^[1]\d{0,10}$/,d=/[a-zA-Z\u4e00-\u9fa5]+/,e=c.test(keyword),f=d.test(keyword);if(""===keyword)column="tel",tooltip(".srh-input","请输入姓名/手机号码");else if(e)column="tel";else{if(!f)return void tooltip(".srh-input","请输入正确的手机或姓名");column="name",tooltip(".srh-input","请输入姓名/手机号码")}8==b&&""==keyword&&$("#srh-btn").trigger("click"),13==b&&$("#srh-btn").trigger("click")}),$("#srh-btn").on("click",function(){memberRequest(member.getCache(),member.getRows())}),$(".srh-input").on("blur",function(){$(".srh-input").tooltip("destroy")})}function memberRequest(a,b){var c=$("#js_sort_menu").find(".cell .selected"),d="memid",e="asc";c.each(function(){var a=$(this),b=a.attr("menu");"sort_file"===b?d=a.attr("val"):e="0"===a.attr("val")?"desc":"asc"}),$.ajax({url:"/member/doSearch/"+currentPage,type:"post",dataType:"json",data:{keyword:keyword,column:column,sortColumn:d,sortType:e,num:b},success:function(c){if(c.success){a.clear();var d=c.result;baseUrl=c.url;var e=get("table_list").getElementsByTagName("tbody");e.length>0&&document.getElementById("table_list").removeChild(e[0]),e[0]=document.createElement("tbody"),document.getElementById("table_list").appendChild(e[0]);for(var f=document.createDocumentFragment(),g=0;g<d.length;g++){var h=d[g];a.set(h.memId,h);var i=renderTable(h);f.appendChild(i)}e[0].appendChild(f),popoverMemberDetail();var j={id:"#pagebar",totalPages:c.totalPages,currentPage:c.curPage,onPageChanged:function(c,d,e){console.log("Current page changed, old: "+d+" new: "+e),currentPage=e,memberRequest(a,b)}};paginator.paging(c.totalPages>1?j:j)}else layer.msg("对不起，没有找到匹配结果");$("input").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal"})}})}function popoverMemberDetail(){$.get("/html/memberDetail.html?t="+(new Date).getTime(),function(a){$("#table_list td a").on("shown.bs.popover",function(){var a=$(this).parent().siblings().eq(0).find("input").attr("data-id"),b=member.getCache(),c=b.get(a);$("#pop_memberName").text(c.name),$("#pop_job").text(c.job),$("#pop_corp").text(c.corpName),$("#pop_website").text(c.website);var d="";d=""==c.avatar?baseUrl+"/assets/avatar/head.png":baseUrl+"/assets/avatar/"+c.avatar,$("#pop_avatar").attr("src",d)}),$("#table_list td a").popover({html:!0,animation:!1,trigger:"manual",placement:"right",title:"会员信息",content:a,container:"body"}).on("mouseenter",function(){var a=this;$(this).popover("show"),$(".popover").on("mouseleave",function(){$(a).popover("hide")})}).on("mouseleave",function(){var a=this;setTimeout(function(){$(".popover:hover").length||$(a).popover("hide")},10)})})}function renderTable(a){var b,c,d,e=get("table_list").getElementsByTagName("th");b=document.createElement("tr");for(var f=0;f<e.length;f++){c=document.createElement("td"),b.appendChild(c);var g=e[f],h=g.getAttribute("data-type");if("checkbox"===h)d=document.createElement("input"),d.type="checkbox",d.name="checkRow",d.setAttribute("data-id",a.memId),c.appendChild(d),c.style.textAlign="center";else switch(h){case"gender":c.innerText=0===a[h]?"女":"男";break;case"name":c.innerHTML="<a href='javascript:;'>"+a[h]+"</a>";break;default:c.innerText=a[h]}}return b}function loadPage(){$("#memberAddModal").on("shown.bs.modal",function(){$("#memberAdd_dialog").load("/html/member.html?t="+(new Date).getTime()+" #memberAdd",function(){$("#memberJoinTime").datetimepicker({language:"zh-CN",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,forceParse:0,pickerPosition:"bottom-left"}),addSave(),formValidate()})}),$("#memberEditModal").on("show.bs.modal",function(){var a=inputChecked("table_list");return a.length<1?(layer.msg("请选择要编辑的会员",2,{type:1,shade:!1}),$("#memberEditModal").modal("hide"),!1):a.length>1?(layer.msg("不能同时编辑多个会员",2,{type:1,shade:!1}),$("#memberEditModal").modal("hide"),!1):void 0}),$("#memberEditModal").on("shown.bs.modal",function(){var a=inputChecked("table_list");$("#memberEdit_dialog").load("/html/member.html?t="+(new Date).getTime()+" #memberEdit",function(){$("#memberJoinTimeEdit").datetimepicker({language:"zh-CN",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,forceParse:0,pickerPosition:"bottom-left"});var b=a[0].getAttribute("data-id");getMemberById(Number(b)),memberUpdate(b)})})}function addSave(){$("#member-add-btn").off("click").on("click",function(){if(""===$("#memberName").val())return $("#memberName").parents(".form-group").addClass("has-error").find(".help-inline").text("请输入用户真实姓名"),!1;if(""===$("#memberTel").val())return $("#memberTel").parents(".form-group").addClass("has-error").find(".help-inline").text("手机号作为登录账号,请填写手机号"),!1;if(""===$("#joinTime").val())return $("#joinTime").parents(".form-group").addClass("has-error").find(".help-inline").text("请输入入会时间"),!1;var a=telValidate();return a?void addRequest():!1})}function addRequest(){var a=$("#memberAddForm").serialize(),b=serial2Json.stj(a);$.ajax({url:"/member/new",type:"post",dataType:"json",data:b,success:function(a){if(a.success){var b=a.totalPages;currentPage=b,memberRequest(member.getCache(),member.getRows()),$("#memberAddModal").modal("hide")}}})}function formValidate(){$("#memberName").off("blur").on("blur",function(){var a=$(this).val();""===trim(a)?$(this).parents(".form-group").addClass("has-error").find(".help-inline").text("请输入用户姓名"):$(this).parents(".form-group").removeClass("has-error").find(".help-inline").text("")}),$("#memberTel").off("blur").on("blur",function(){var a=$(this).val();""===trim(a)?$(this).parents(".form-group").addClass("has-error").find(".help-inline").text("手机号作为登录账号,请填写手机号"):/^[1]\d{10}$/.test(a)?$(this).parents(".form-group").removeClass("has-error").find(".help-inline").text(""):$(this).parents(".form-group").addClass("has-error").find(".help-inline").text("手机号码格式错误，请重新输入")}),$("#memberEmail").off("blur").on("blur",function(){var a=$(this).val(),b=/^([a-zA-Z0-9_-]\.*)+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/;""===trim(a)?$(this).parents(".form-group").addClass("has-error").find(".help-inline").text("请输入邮箱"):b.test(a)?$(this).parents(".form-group").removeClass("has-error").find(".help-inline").text(""):$(this).parents(".form-group").addClass("has-error").find(".help-inline").text("请输入正确的邮箱")}),$("#joinTime").off("blur").on("blur",function(){var a=$(this).val();""===trim(a)?$(this).parents(".form-group").addClass("has-error").find(".help-inline").text("请输入入会时间"):$(this).parents(".form-group").removeClass("has-error").find(".help-inline").text("")}),$(".datetimepicker-days").on("click",function(){$("#joinTime").parents(".form-group").removeClass("has-error").find(".help-inline").text("")}),$("#memberJob").off("blur").on("blur",function(){var a=$(this).val();""===trim(a)?$(this).parents(".form-group").addClass("has-error").find(".help-inline").text("请输入职位"):$(this).parents(".form-group").removeClass("has-error").find(".help-inline").text("")}),$("#memberCorpName").off("blur").on("blur",function(){var a=$(this).val();""===trim(a)?$(this).parents(".form-group").addClass("has-error").find(".help-inline").text("请输入企业名称"):$(this).parents(".form-group").removeClass("has-error").find(".help-inline").text("")}),$("#memberCorpwebsite").off("blur").on("blur",function(){var a=$(this).val();""===trim(a)?$(this).parents(".form-group").addClass("has-error").find(".help-inline").text("请输入企业网址"):$(this).parents(".form-group").removeClass("has-error").find(".help-inline").text("")}),$("#memberCorpIntro").off("blur").on("blur",function(){var a=$(this).val();""===trim(a)?$(this).parents(".form-group").addClass("has-error").find(".help-inline").text("请输入企业介绍"):$(this).parents(".form-group").removeClass("has-error").find(".help-inline").text("")})}function telValidate(){var a=$("#memberTel").val();if(/^[1]\d{10}$/.test(a)){var b=!1;return $.ajax({url:"/member/doValidate",type:"get",dataType:"json",data:{tel:a},async:!1,success:function(a){a.success?($("#memberTel").parents(".form-group").addClass("has-error").find(".help-inline").text(a.message),b=!1):($("#memberTel").parents(".form-group").addClass("has-error").find(".help-inline").text(a.message),b=!0)}}),b}}function deleteMember(){$("#member_del").on("click",function(){var a=inputChecked("table_list");return a.length<1?(layer.msg("请选择要删除的资讯",2,{type:1,shade:!1}),!1):void(1==a.length?layer.confirm("确定删除吗？",function(b){if(console.log(a.length),1===a.length){var c=Number(a[0].getAttribute("data-id"));$.ajax({url:"/member/del/"+c,type:"delete",dataType:"json",success:function(a){a.success&&memberRequest(member.getCache(),member.getRows())}})}layer.close(b)}):a.length>1&&layer.msg("会员暂不支持批量删除"))})}function getMemberById(a){$.get("/member/findById/"+a,function(a){if(a.success){var b=a.result,c=b.name,d=b.gender,e=b.email,f=b.joinTime,g=b.job,h=b.corpName,i=b.corpIntro,j=b.website;$("#memberNameEdit").val(c),$("#memberEmailEdit").val(e),$("#joinTimeEdit").val(f),$("#memberJobEdit").val(g),$("#memberCorpNameEdit").val(h),$("#memberCorpIntroEdit").val(i),$("#memberCorpwebsiteEdit").val(j),1==d?$("#gender1").attr("checked","checked"):$("#gender0").attr("checked","checked")}})}function memberUpdate(a){$("#member-edit-btn").on("click",function(){var b=trim($("#memberNameEdit").val()),c=jQuery('input[type="radio"][name="gender"]:checked').val(),d=trim($("#memberEmailEdit").val()),e=trim($("#joinTimeEdit").val()),f=trim($("#memberJobEdit").val()),g=$("#memberCorpNameEdit").val(),h=$("#memberCorpIntroEdit").val(),i=$("#memberCorpwebsiteEdit").val();return""===$("#memberNameEdit").val()?($("#memberNameEdit").parents(".form-group").addClass("has-error").find(".help-inline").text("请输入用户真实姓名"),!1):""===$("#joinTimeEdit").val()?($("#joinTimeEdit").parents(".form-group").addClass("has-error").find(".help-inline").text("请输入入会时间"),!1):""===$("#memberJobEdit").val()?($("#memberJobEdit").parents(".form-group").addClass("has-error").find(".help-inline").text("请输入职位"),!1):""===$("#memberCorpNameEdit").val()?($("#memberCorpNameEdit").parents(".form-group").addClass("has-error").find(".help-inline").text("请输入企业名称"),!1):""===$("#memberCorpwebsiteEdit").val()?($("#memberCorpwebsiteEdit").parents(".form-group").addClass("has-error").find(".help-inline").text("请输入企业网址"),!1):""===$("#memberCorpIntroEdit").val()?($("#memberCorpIntroEdit").parents(".form-group").addClass("has-error").find(".help-inline").text("请输入企业介绍"),!1):void $.ajax({url:"/member/"+a,type:"post",dataType:"json",data:{_method:"PUT",name:b,gender:c,email:d,joinTime:e,job:f,corpName:g,corpIntro:h,website:i},success:function(a){a.success&&(currentPage=1,memberRequest(member.getCache(),member.getRows()),$("#memberEditModal").modal("hide"))}})})}var currentPage=1,baseUrl="",column="tel",keyword="";String.prototype.isCHS=function(a){return this.charCodeAt(a)>255||this.charCodeAt(a)<0?!0:!1};var member=function(a){var b=new DataCache,c=15,d=function(){var d=a(".srh-input").val();return""===d?void tooltip(".srh-input","请输入姓名/手机号码"):void memberRequest(b,c)},e=function(){return b},f=function(){return c};return{findList:d,getCache:e,getRows:f}}(jQuery),serial2Json=function(a){return a.stj=function(a){function b(a){return new Function("return "+a)()}a=decodeURIComponent(a,!0);var c=a.replace(/&/g,"',"),d=c.replace(/[+]/g,""),e="{"+d.replace(/=/g,":'")+"'}";console.log(e);var f=b(e);return f},a}({});$(function(){userMenu(),checkAllEvent(),memberList(),$("#member-add").popover({html:!0,trigger:"click",placement:"bottom",title:"会员信息",content:function(){},container:"body"}),$(".srh-input").tooltip({trigger:"click",placement:"bottom",title:"请输入姓名/手机号码"})});