/*! site 30-07-2014 */
function noticeList(){$("#myModal").on("show.bs.modal",function(){$("#noticeAdd_dialog").load("/html/notice.html?t="+(new Date).getTime()+" #noticeAdd",function(){newNotice();var a={fileInput:$("#fileupload"),context:$("#files"),hiddenInput:$("#fileName"),progress:"progress"};infoUpload(a),$("#coverSwitch").on("change",function(){var a=this.checked;a&&$(this).parent().addClass("hide").next().removeClass("hide")})})}),$("#noticeEditModal").on("show.bs.modal",function(){var a=inputChecked("table_list");return a.length<1?(layer.msg("请选择要编辑的公告",2,{type:1,shade:!1}),!1):a.length>1?(layer.msg("不能同时编辑多条公告",2,{type:1,shade:!1}),!1):void $("#noticeEdit_dialog").load("/html/notice.html?t="+(new Date).getTime()+" #noticeEdit",function(){var b=a[0].getAttribute("data-id");getNoticeById(Number(b)),noticeUpdate(b);var c={fileInput:$("#fileupload1"),context:$("#files1"),hiddenInput:$("#fileName1"),progress:"progress1"};infoUpload(c)})}),notice.findList(),deleteNotice()}function renderTable(a){var b,c,d,e=get("table_list").getElementsByTagName("th");b=document.createElement("tr");for(var f=0;f<e.length;f++){c=document.createElement("td"),b.appendChild(c);var g=e[f],h=g.getAttribute("data-type");if("checkbox"===h)d=document.createElement("input"),d.type="checkbox",d.name="checkRow",d.setAttribute("data-id",a.notId),c.appendChild(d),c.style.textAlign="center";else switch(h){case"status":c.innerHTML="new"==a[h]?"<div class='sts-icon active'></div>":"<div class='sts-icon'></div>";break;case"date":var i=a[h],j=i.substring(5,10);c.innerText=j.replace("-","月");break;default:c.innerText=a[h]}}return b}function newNotice(){$("#notice_new_btn").on("click",function(){var a=trim($("#noticeTitle").val()),b=trim($("#noticeContent").val()),c=$("#fileName").val();return""===a?($("#noticeTitle").parents(".form-group").addClass("has-error").find(".help-block").text("请填写标题"),void $("#noticeTitle").focus()):""===b?($("#noticeContent").parents(".form-group").addClass("has-error").find(".help-block").text("请填写内容"),void $("#noticeContent").focus()):void $.ajax({url:"/notice/new",type:"POST",dataType:"json",data:{title:a,cover:c,content:b},success:function(a){a.success&&(currentPage=1,notice.findList(),$("#myModal").modal("hide"))}})})}function getNoticeById(a){var b="/notice/get/"+a;$.get(b,function(a){if(a.success){var b=a.result,c=b.title,d=b.content,e=b.cover,f=b.coverUrl;$("#noticeEditTitle").val(c),$("#noticeEditContent").val(d),""===e?($("#files1").find("img").hide(),$("#files1").find("i").show()):($("#files1").find("img").attr("src",f+"/assets/img/noti/"+e).show(),$("#files1").find("i").hide())}})}function noticeUpdate(a){$("#notice_Edit_btn").on("click",function(){var b=trim($("#noticeEditTitle").val()),c=trim($("#noticeEditContent").val()),d=$("#fileName1").val();return""===b?void $("#noticeEditTitle").parents(".form-group").addClass("has-error").find(".help-block").text("请填写标题"):""===c?void $("#noticeEditContent").parents(".form-group").addClass("has-error").find(".help-block").text("请填写内容"):void $.ajax({url:"/notice/"+a,type:"post",dataType:"json",data:{_method:"PUT",title:b,content:c,cover:d},success:function(a){a.success&&(currentPage=1,notice.findList(),$("#noticeEditModal").modal("hide"))}})})}function deleteNotice(){$("#notice_del").on("click",function(){var a=inputChecked("table_list");return a.length<1?(layer.msg("请选择要删除的公告",2,{type:1,shade:!1}),!1):void(a.length>0&&layer.confirm("确定删除吗？",function(b){if(console.log(a.length),1===a.length){var c=Number(a[0].getAttribute("data-id"));$.ajax({url:"/notice/del/"+c,type:"delete",dataType:"json",success:function(a){a.success&&notice.findList()}})}else{for(var d="",e=0;e<a.length;e++){var f=a[e],c=Number(f.getAttribute("data-id"));d+=e==a.length-1?c:c+","}$.ajax({url:"/notice/del/batch/"+d,type:"delete",dataType:"json",success:function(b){if(b.success)for(var c=0;c<a.length;c++){var d=a[c];$(d).parents("tr").remove()}}})}layer.close(b)}))})}function noticeSend(){try{var a=new SockJS("http://shanghui.puyuntech.com:7075/chamber")}catch(b){throw new Error("不能连接服务器,请检查")}console.log(a),a.onopen=function(){console.log("socketJs open"),a.send('{"type":""}')},a.onmessage=function(a){console.log("message",a.data);var b=JSON.parse(a.data);b.success&&layer.msg("公告已发送",2,{type:1,shade:!1})},a.onclose=function(){console.log("socketJs close")},$("#notice_send").on("click",function(){var b=inputChecked("table_list"),c="",d="",e="",f=inputChecked("table_list");if(f.length<1)return layer.msg("请选择要发送的公告",2,{type:1,shade:!1}),!1;if(b.length>0){for(var g=0;g<b.length;g++){var h=b[g],i=$(h).attr("data-id"),j=notice.getCache(),k=j.get(i);if("undefined"==typeof k)return;var l=null===k.cover?"":k.cover;g==b.length-1?(e+=i,c+='{"notId":"'+k.notId+'","title":"'+k.title+'","cover":"'+l+'","content":"'+k.content+'","date":"'+k.date+'"}'):(c+='{"notId":"'+k.notId+'","title":"'+k.title+'","cover":"'+l+'","content":"'+k.content+'","date":"'+k.date+'"},',e+=i+",")}d='{"type":"notice","msg":['+c+"]}"}a.send(d),noticeStatus(e)})}function noticeStatus(a){$.ajax({url:"/notice/sts/"+a,type:"post",dataType:"json",data:{_method:"PUT",status:"sent"},success:function(a){a.success&&notice.findList()}})}function noticeSearch(){$(".srh-input").keyup(function(a){var a=a||event;keycode=a.which||a.keyCode;var b=$(".srh-input").val();8==keycode&&""==b&&$("#srh-btn").trigger("click"),13==keycode&&$("#srh-btn").trigger("click")}),$("#srh-btn").on("click",function(){notice.findList()})}var currentPage=1,notice=function(a){var b=new DataCache,c=15,d=function(){var d=a(".srh-input").val(),e=/[a-zA-Z0-9_\u4e00-\u9fa5]+/,f=e.test(d);return f||""==d?(a(".srh-input").tooltip("destroy"),a(".srh-input").tooltip({trigger:"focus",placement:"bottom",title:"请输入标题名称"}),void a.ajax({url:"/notice/doSearch/"+currentPage,type:"post",dataType:"json",data:{keyword:d,num:c},success:function(c){if(c.success){b.clear();var d=c.result,e=get("table_list").getElementsByTagName("tbody");e.length>0&&document.getElementById("table_list").removeChild(e[0]),e[0]=document.createElement("tbody"),document.getElementById("table_list").appendChild(e[0]);for(var f=document.createDocumentFragment(),g=0;g<d.length;g++){var h=d[g];b.set(h.notId,h);var i=renderTable(h);f.appendChild(i)}e[0].appendChild(f);var j={id:"#pagebar",totalPages:c.totalPages,currentPage:c.curPage,onPageChanged:function(a,b,c){console.log("Current page changed, old: "+b+" new: "+c),currentPage=c,notice.findList()}};paginator.paging(c.totalPages>1?j:j)}else layer.msg("对不起，没有找到匹配结果",2,{type:1,shade:!1});a("input").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal"})}})):void tooltip(".srh-input","格式错误")},e=function(){return b};return{findList:d,getCache:e}}(jQuery);$(function(){userMenu(),checkAllEvent(),noticeList(),noticeSend(),noticeSearch(),$(".srh-input").tooltip({trigger:"click",placement:"bottom",title:"请输入标题名称"})});