/*! site 30-07-2014 */
function messageList(){$("#messageAddModal").on("shown.bs.modal",function(){$("#messageAdd_dialog").load("/html/information.html?t="+(new Date).getTime()+" #messageAdd",function(){$("#messageAddModal").show();var a=new Simditor({textarea:$("#infoContent"),placeholder:"",upload:{url:"/controller/upload/1",params:null,connectionCount:1,leaveConfirm:"正在上传文件，如果离开上传会自动取消"}});newMessage(a),infoValidate(a);var b={fileInput:$("#fileupload"),context:$("#files"),hiddenInput:$("#fileName"),progress:"progress",uploaddone:function(){$("#fileName").parents(".form-group").removeClass("has-error").find(".help-inline").text("")}};infoUpload(b)})}),$("#messageEditModal").on("show.bs.modal",function(){var a=inputChecked("table_list");return a.length<1?(layer.msg("请选择要编辑的资讯",2,{type:1,shade:!1}),!1):a.length>1?(layer.msg("不能同时编辑多条资讯",2,{type:1,shade:!1}),!1):void $("#messageEdit_dialog").load("/html/information.html?t="+(new Date).getTime()+" #messageEdit",function(){$("#messageEditModal").show();var b=new Simditor({textarea:$("#infoEditContent"),placeholder:"",upload:{url:"/controller/upload/1",params:null,connectionCount:1,leaveConfirm:"正在上传文件，如果离开上传会自动取消"}}),c={fileInput:$("#fileupload1"),context:$("#files1"),hiddenInput:$("#fileName1"),progress:"progress1",uploaddone:function(){$("#fileName1").parents(".form-group").removeClass("has-error").find(".help-inline").text("")}};infoUpload(c);var d=a[0].getAttribute("data-id");getMessageById(Number(d),b),messageUpdate(d,b)})}),message.findList(),deleteMessage(),informationSend()}function renderTable(a){var b,c,d,e=get("table_list").getElementsByTagName("th");b=document.createElement("tr");for(var f=0;f<e.length;f++){c=document.createElement("td"),b.appendChild(c);var g=e[f],h=g.getAttribute("data-type");if("checkbox"===h)d=document.createElement("input"),d.type="checkbox",d.name="checkRow",d.setAttribute("data-id",a.msgId),c.appendChild(d),c.style.textAlign="center";else switch(h){case"status":c.innerHTML="new"==a[h]?"<div class='sts-icon active'></div>":"<div class='sts-icon'></div>";break;case"date":var i=a[h],j=i.substring(5,10);c.innerText=j.replace("-","月");break;default:c.innerText=a[h]}}return b}function newMessage(a){$("#message_new_btn").on("click",function(){var b=$("#messageCategory").val(),c=trim($("#infoTitle").val()),d=trim($("#infoSummary").val()),e=a.getValue(),f=$("#fileName").val();return""===c?void $("#infoTitle").parents(".form-group").addClass("has-error").find(".help-inline").text("请填写标题"):""===f?void $("#fileName").parents(".form-group").addClass("has-error").find(".help-inline").text("请上传资讯封面"):""===d?void $("#infoSummary").parents(".form-group").addClass("has-error").find(".help-inline").text("请填写概述"):""===e?void $("#infoContent").parents(".form-group").addClass("has-error").find(".help-inline").text("请填写内容"):void $.ajax({url:"/message/new",type:"POST",dataType:"json",data:{cateId:b,title:c,cover:f,summary:d,content:e},success:function(a){a.success&&(currentPage=1,message.findList(),$("#messageAddModal").modal("hide"))}})})}function infoValidate(a){$("#infoTitle").blur(function(){var a=$(this).val();""!==a&&$(this).parents(".form-group").removeClass("has-error").find(".help-inline").text("")}),$("#fileName").blur(function(){var a=$(this).val();""!==a&&$(this).parents(".form-group").removeClass("has-error").find(".help-inline").text("")}),$("#infoSummary").blur(function(){var a=$(this).val();""!==a&&$(this).parents(".form-group").removeClass("has-error").find(".help-inline").text("")}),a.on("blur",function(){var b=a.getValue();""!==b&&$("#infoContent").parents(".form-group").removeClass("has-error").find(".help-inline").text("")})}function getMessageById(a,b){$.get("/message/info/"+a,function(a){if(a.success){var c=a.result,d=c.title,e=c.content,f=c.summary,g=c.cover,h=c.url;$("#infoEditTitle").val(d),$("#infoEditSummarize").val(f),$("#fileName1").val(g),$("#files1").find("img").attr("src",h+"/assets/img/info/"+g).show(),$("#files1").find("i").hide(),b.setValue(e)}})}function messageUpdate(a,b){$("#message_edit_btn").on("click",function(){var c=trim($("#infoEditTitle").val()),d=$("#fileName1").val(),e=trim($("#infoEditSummarize").val()),f=b.getValue();return""===c?void $("#infoEditTitle").parents(".form-group").addClass("has-error").find(".help-inline").text("请填写标题"):""===d?void $("#fileName1").parents(".form-group").addClass("has-error").find(".help-inline").text("请上传资讯封面"):""===e?void $("#infoEditSummarize").parents(".form-group").addClass("has-error").find(".help-inline").text("请填写概述"):""===f?void $("#infoEditContent").parents(".form-group").addClass("has-error").find(".help-inline").text("请填写内容"):void $.ajax({url:"/message/"+a,type:"post",dataType:"json",data:{_method:"PUT",summary:e,cover:d,title:c,content:f},success:function(a){a.success&&(currentPage=1,message.findList(),$("#messageEditModal").modal("hide"))}})})}function deleteMessage(){$("#notice_del").on("click",function(){var a=inputChecked("table_list");return a.length<1?(layer.msg("请选择要删除的资讯",2,{type:1,shade:!1}),!1):void(a.length>0&&layer.confirm("确定删除吗？",function(b){if(console.log(a.length),1===a.length){var c=Number(a[0].getAttribute("data-id"));$.ajax({url:"/message/del/"+c,type:"delete",dataType:"json",success:function(a){a.success&&message.findList()}})}else{for(var d="",e=0;e<a.length;e++){var f=a[e],c=Number(f.getAttribute("data-id"));d+=e==a.length-1?c:c+","}$.ajax({url:"/message/del/batch/"+d,type:"delete",dataType:"json",success:function(b){if(b.success)for(var c=0;c<a.length;c++){var d=a[c];$(d).parents("tr").remove()}}})}layer.close(b)}))})}function informationSend(){try{var a=new SockJS("http://shanghui.puyuntech.com:7075/chamber")}catch(b){throw new Error("不能连接服务器,请检查"+b)}console.log(a),a.onopen=function(){console.log("socketJs open"),a.send('{"type":""}')},a.onmessage=function(a){console.log("message",a.data);var b=JSON.parse(a.data);b.success&&layer.msg("资讯已发送",2,{type:1,shade:!1})},a.onclose=function(){console.log("socketJs close")},$("#message_send").on("click",function(){var b=inputChecked("table_list"),c="",d=inputChecked("table_list");if(d.length<1)return layer.msg("请选择要发送的资讯",2,{type:1,shade:!1}),!1;if(1!==b.length)return void layer.msg("资讯不支持多条推送",2,{type:2,shade:!1});for(var e=0;e<b.length;e++)var f=b[e],g=$(f).attr("data-id"),h=message.getCache(),i=h.get(g),j={type:"info",msg:[{cateId:i.cateId,category:i.category,cateCover:i.cateCover,msgId:i.msgId,title:i.title,cover:i.cover,summary:i.summary,date:i.date}]};c=JSON.stringify(j),a.send(c),messageStatus(g)})}function messageStatus(a){$.ajax({url:"/message/sts/"+a,type:"post",dataType:"json",data:{_method:"PUT",status:"sent"},success:function(a){a.success&&message.findList()}})}function messageSearch(){$(".srh-input").keyup(function(a){var a=a||event;keycode=a.which||a.keyCode;var b=$(".srh-input").val();8==keycode&&""==b&&$("#srh-btn").trigger("click"),13==keycode&&$("#srh-btn").trigger("click")}),$("#srh-btn").on("click",function(){message.findList()})}var currentPage=1,message=function(a){var b=new DataCache,c=15,d=function(){var d=a(".srh-input").val(),e=/[a-zA-Z0-9_\u4e00-\u9fa5]+/,f=e.test(d);return f||""==d?(a(".srh-input").tooltip("destroy"),a(".srh-input").tooltip({trigger:"focus",placement:"bottom",title:"请输入标题名称"}),void a.ajax({url:"/message/doSearch/"+currentPage,type:"post",dataType:"json",data:{keyword:d,num:c},success:function(c){if(c.success){b.clear();var d=c.result,e=get("table_list").getElementsByTagName("tbody");e.length>0&&document.getElementById("table_list").removeChild(e[0]),e[0]=document.createElement("tbody"),document.getElementById("table_list").appendChild(e[0]);for(var f=document.createDocumentFragment(),g=0;g<d.length;g++){var h=d[g];b.set(h.msgId,h);var i=renderTable(h);f.appendChild(i)}e[0].appendChild(f);var j={id:"#pagebar",totalPages:c.totalPages,currentPage:c.curPage,onPageChanged:function(a,b,c){console.log("Current page changed, old: "+b+" new: "+c),currentPage=c,message.findList()}};paginator.paging(c.totalPages>1?j:j)}else layer.msg("对不起，没有找到匹配结果",2,{type:1,shade:!1});a("input").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal"})}})):void tooltip(".srh-input","格式错误")},e=function(){return b};return{findList:d,getCache:e}}(jQuery);$(function(){userMenu(),checkAllEvent(),messageList(),messageSearch(),$(".srh-input").tooltip({trigger:"click",placement:"bottom",title:"请输入标题名称"})});